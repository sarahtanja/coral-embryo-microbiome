---
title: "Assign taxonomy"
author: "Sarah Tanja"
format: gfm
toc: true
toc-title: Contents <i class="bi bi-bookmark-heart"></i>
toc-depth: 5
toc-location: left
bibliography: "../microbiome_bibtex.bib"
reference-location: margin
citation-location: margin
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,         # Display code chunks
  eval = FALSE,        # Evaluate code chunks
  warning = FALSE,     # Hide warnings
  message = FALSE,     # Hide messages
  comment = ""         # Prevents appending '##' to beginning of lines in code output
)
```

# Goals

Assign taxonomy to all the feature table sequences

# Load packages

```{r}
library(knitr)
library(dplyr)
library(stringr)
library(readr)
library(reticulate)
```

# Get taxonomy classifier

```{r, engine='bash'}
# Specify the directory where you want to save the downloaded file
cd ../input

# Download the classifier and save it under input directory
wget -O silva-138-99-515-806-nb-classifier.qza \
  https://data.qiime2.org/2023.9/common/silva-138-99-515-806-nb-classifier.qza

wget -O silva-138-99-nb-classifier.qza \ 
  https://data.qiime2.org/classifiers/sklearn-1.4.2/silva/silva-138-99-nb-classifier.qza
```

# Activate qiime2 environment in R

This is equivalent to `conda activate qiime2-2023.5` in the terminal but allows running qiime commands in r chunks with engine ='bash' throughout the quarto markdown doc.

```{r load-qiime-env, eval=TRUE}
use_condaenv(condaenv = "qiime2-2023.5", conda = "/home/shared/8TB_HDD_02/stanja/miniconda3/condabin/conda")

# Check successful env loading
py_config()
```

> # Classify reads
>
> qiime feature-classifier classify-sklearn\\
>
> --i-classifier ../training-feature-classifiers/silva-naive-bayes-classifier.qza \\
>
> --i-reads 250414_StonyCoral_270x200_representative-sequences.qza \\
>
> --p-n-jobs 40 \\
>
> --o-classification 250414_270x200_representative-sequences_taxonomy

```{r, engine='bash'}
qiime feature-classifier classify-sklearn \
    --i-reads ../output/dada2/representative_sequences.qza \
    --i-classifier ../input/silva-138-99-515-806-nb-classifier.qza \
    --p-n-jobs 2 \
    --output-dir ../output/taxonomy --verbose

```

> # Remove Unassigned, mitochodria and chloroplast
>
> qiime taxa barplot \--i-table 250414_StonyCoral_270x200_featureTable.qza \--i-taxonomy 250414_270x200_representative-sequences_taxonomy.qza \--m-metadata-file ../250416_StonyCoral_metadata.tsv \--o-visualization 250414_StonyCoral_270x200_taxa-bar-plots.qzv
>
> qiime taxa filter-table \\
>
> \--i-table 250414_StonyCoral_270x200_featureTable.qza \\
>
> \--i-taxonomy 250414_270x200_representative-sequences_taxonomy.qza \\
>
> \--p-exclude mitochondria,chloroplast,Unassigned \\
>
> \--o-filtered-table 250414_StonyCoral_270x200_featureTable_filtered.qza
