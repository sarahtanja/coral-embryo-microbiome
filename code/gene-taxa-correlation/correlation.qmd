---
title: "Correlation Analysis"
author: "Sarah Tanja"
date-modified: today
format:
  gfm: 
    toc: true
    number-sections: true
  html:
    theme: journal
    highlight-style: github
    page-layout: article
    code-background: true
    code-tools: 
      source: true
      toggle: true
    toc: true
    toc-depth: 2
    toc-location: left
    number-sections: true
    df-print: kable
    smooth-scroll: true
    link-external-icon: true
    link-external-newwindow: true
    reference-location: margin
    citation-location: margin
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, # Display code chunks
  eval = TRUE, # Evaluate code chunks
  warning = FALSE, # Hide warnings
  message = FALSE, # Hide messages
  comment = "")        
```

# Background

see issue [2353](https://github.com/RobertsLab/resources/issues/2352)

# Setup 
## Install packages
## Load libraries
```{r}
library(tidyverse)
library(compositions)
library(zCompositions)
```
## Set paths
```{r}
# Define file paths
feature_table_path <- "../../salipante/241121_StonyCoral/270x200/collapsed-l7.qza"
metadata_path <- "../../metadata/meta.csv"
taxonomy_path <- "../../salipante/241121_StonyCoral/270x200/250414_270x200_representative-sequences_taxonomy.qza"
```
## Load data

### DEGs

```{r}
norm_count_mat <- read_csv("../../input/host-significant/norm_count_mat.csv") # vst normalized gene count matrix
sig_summary <- read_csv("../../input/host-significant/sig_summary.csv") # summary of DEGs log2FC & pval per test/contrast
sig_all <- read_csv("../../input/host-significant/sig_all.csv") # list of 151 significant DEGs gene_id
```

Use a semi-join (keeps rows from `norm_count_mat` whose gene_id exists in `sig_all`)

```{r}
da_gene_matrix <- norm_count_mat %>% 
  semi_join(sig_all, by = "gene_id") 
```

### DATs

```{r}
# Load feature table from QIIME2 artifact
ft_l7 <- read_qza(feature_table_path)$data

# Convert to data.frame
ft_l7 <- ft_l7 %>% 
  as.data.frame()

# QIIME2 format typically has features as rows, samples as columns
ft_l7 <- t(ft_l7)  # Transpose so samples are rows, taxa are columns
```

CLR Transformation

The centered log-ratio (CLR) transformation converts compositional data to Euclidean space. It handles zeros by replacing them with small values (geometric Bayesian multiplicative replacement).

```{r}
# Replace zeros with small values using cmultRepl from zCompositions
# This is necessary because log transformation is undefined for zeros
ft_l7_nozero <- cmultRepl(ft_l7, method = "CZM", label = 0)

# Apply CLR transformation
ft_l7_clr <- clr(ft_l7_nozero)

# Convert to data frame for easier handling
ft_l7_clr_df <- as.data.frame(ft_l7_clr)
```


```{r}
clr_feature_table <- read_csv()
sig_res <- read_tsv("../../output/maaslin-taxa/Interaction/interaction_cat.con/significant_results.tsv")
```

```{r}
da_taxa_matrix
```


# SparCC Correlation Analysis

SparCC is designed specifically for compositional data and infers correlations while accounting for the compositional constraint.

```{r}
# Note: SparCC implementation can be done using SpiecEasi package
# or the sparcc function from various implementations

# If SpiecEasi is installed, uncomment and use:
# library(SpiecEasi)
# 
# # Run SparCC
# sparcc_result <- sparcc(t(feature_matrix_t))
# 
# # Extract correlation matrix
# sparcc_cor <- sparcc_result$Cor
# rownames(sparcc_cor) <- colnames(feature_matrix_t)
# colnames(sparcc_cor) <- colnames(feature_matrix_t)
# 
# # Plot correlation matrix (subset for visualization)
# # Select top 50 most abundant features
# feature_abundance <- colSums(feature_matrix_t)
# top_features <- names(sort(feature_abundance, decreasing = TRUE)[1:50])
# 
# sparcc_cor_subset <- sparcc_cor[top_features, top_features]
# 
# # Create correlation plot
# png("../output/sparcc_correlation_plot.png", width = 12, height = 12, units = "in", res = 300)
# corrplot(sparcc_cor_subset, method = "color", type = "upper",
#          tl.cex = 0.5, tl.col = "black",
#          title = "SparCC Correlation Matrix (Top 50 Features)",
#          mar = c(0, 0, 2, 0))
# dev.off()

cat("SparCC analysis requires SpiecEasi package.\n")
cat("To run SparCC, install SpiecEasi and uncomment the code above.\n")
cat("Installation: devtools::install_github('zdk123/SpiecEasi')\n")
```

```{r}
# Alternative: Calculate correlations on CLR-transformed data
# This is a simpler approach that approximates compositional correlations

# Calculate correlation matrix on CLR-transformed data
clr_cor <- cor(feature_clr, method = "pearson")

# Select top abundant features for visualization
feature_abundance <- colSums(feature_matrix_t)
top_features <- names(sort(feature_abundance, decreasing = TRUE)[1:50])

clr_cor_subset <- clr_cor[top_features, top_features]

# Create correlation plot
png("../output/clr_correlation_plot.png", width = 12, height = 12, units = "in", res = 300)
corrplot(clr_cor_subset, method = "color", type = "upper",
         tl.cex = 0.5, tl.col = "black",
         title = "Correlation Matrix on CLR-Transformed Data (Top 50 Features)",
         mar = c(0, 0, 2, 0))
dev.off()

cat("Correlation plot saved to: ../output/clr_correlation_plot.png\n")
```

Correlate DE effect sizes (log fold-changes)
What: correlate log2 fold-changes (LFC) from DE genes with log fold-changes or effect sizes of DA taxa across conditions (i.e., compare LFC vectors).
Pros: reduces dimensionality and focuses on features that change; easier to interpret biologically.
Cons: LFCs across very different data types are not directly comparable; sample-size for correlation is limited by number of significant features.
Caution: control for significance-selection bias; consider rank-based associations (Spearman) and examine direction consistency.