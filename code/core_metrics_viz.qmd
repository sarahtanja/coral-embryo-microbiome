---
title: "Core Metrics Visualization"
author: "Sarah Tanja"
date: 2025-10-15
date-modified: today
format:
  gfm: default 
  html:
    theme: journal
    highlight-style: github
    page-layout: full
    code-background: true
    code-tools: 
      source: true
      toggle: true
    toc: true
    toc-depth: 2
    toc-location: left
    df-print: kable
    smooth-scroll: true
    link-external-icon: true
    link-external-newwindow: true
    reference-location: margin
    citation-location: margin
---

# Background

This document visualizes core diversity metrics from the filtered QIIME2 analysis (`core-metrics-results-filtered/`). The filtered dataset excludes chloroplast, mitochondria, and unassigned sequences.

Core metrics include:
- **Alpha Diversity**: Shannon diversity, Faith's Phylogenetic Diversity, Evenness, Observed Features
- **Beta Diversity**: Bray-Curtis, Jaccard, Weighted UniFrac, Unweighted UniFrac

# Setup

## Install Packages & Load Libraries
```{r}
# restart R session first (Session > Restart R), then run:

options(timeout = 600)                         # give downloads 10 minutes
options(download.file.method = "libcurl")      # reliable on Windows
chooseCRANmirror(ind = 1)                      # or set a mirror explicitly:
options(repos = c(CRAN = "https://cloud.r-project.org"))

# remove any half-installed packages from a previous failed attempt
unlink(file.path(.libPaths()[1], "bslib"), recursive = TRUE, force = TRUE)
unlink(file.path(.libPaths()[1], "stringi"), recursive = TRUE, force = TRUE)
unlink(file.path(tempdir(), "downloaded_packages"), recursive = TRUE, force = TRUE)

install.packages(c("stringi","bslib"), type = "binary", Ncpus = max(1, parallel::detectCores() - 1))
install.packages("tidyverse", type = "binary", Ncpus = max(1, parallel::detectCores() - 1))


install.packages("pak")
pak::pak("tidyverse")   # pak will fetch the right binaries and retry on transient errors

```


```{r}
install.packages("devtools")
devtools::install_github("jbisanz/qiime2R")

install.packages("tidyverse")
install.packages("ggplot2")
install.packages("patchwork")
```


```{r}
#| message: false
#| warning: false
library(qiime2R)
library(ggplot2)
library(tidyverse)
library(patchwork)
```

## Set Paths

```{r}
# Base path to core metrics results
core_metrics_path <- "../salipante/241121_StonyCoral/core-metrics-results-filtered"
metadata_path <- "../metadata/metadata.tsv"

# Output directory for figures
figures_dir <- "../output/figures"

# Create figures directory if it doesn't exist
if (!dir.exists(figures_dir)) {
  dir.create(figures_dir, recursive = TRUE)
}
```

## Load Metadata

```{r}
metadata <- read_q2metadata(metadata_path)
head(metadata)
```

# Alpha Diversity

**Alpha diversity measures the diversity within individual samples.**

## Shannon Diversity Index

Shannon diversity accounts for both abundance and evenness of species present.

```{r, shannon-data}
# Load Shannon diversity vector
shannon <- read_qza(file.path(core_metrics_path, "shannon_vector.qza"))

# Create data frame
shannon_df <- shannon$data %>%
  rownames_to_column("SampleID") %>%
  rename(Shannon = shannon_entropy) %>%
  left_join(metadata, by = "SampleID")

head(shannon_df)
```

```{r, shannon-boxplots}
#| fig-width: 13
#| fig-height: 12

# Box plot by leachate treatment
shan1 <- ggplot(shannon_df, aes(x = factor(leachate), y = Shannon, fill = factor(leachate))) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, size = 2, alpha = 0.6) +
  scale_fill_viridis_d(option = "plasma", begin = 0.2, end = 0.9) +
  labs(
    title = "Shannon Diversity by Leachate Treatment",
    x = "Leachate Level",
    y = "Shannon Diversity Index",
    fill = "Leachate"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.title = element_text(size = 12),
    legend.position = "none"
  )

# Box plot by timepoint
shan2 <- ggplot(shannon_df, aes(x = factor(timepoint), y = Shannon, fill = factor(timepoint))) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, size = 2, alpha = 0.6) +
  scale_fill_viridis_d(option = "mako", begin = 0.2, end = 0.9) +
  labs(
    title = "Shannon Diversity by Developmental Timepoint",
    x = "Hours Post Fertilization",
    y = "Shannon Diversity Index",
    fill = "Timepoint"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.title = element_text(size = 12),
    legend.position = "none"
  )

# Box plot by leachate x timepoint interaction
shan3 <- ggplot(shannon_df, aes(x = factor(timepoint), y = Shannon, fill = factor(leachate))) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA, position = position_dodge(width = 0.8)) +
  geom_point(position = position_jitterdodge(jitter.width = 0.1, dodge.width = 0.8), 
             size = 1.5, alpha = 0.6) +
  scale_fill_viridis_d(option = "plasma", begin = 0.2, end = 0.9) +
  labs(
    title = "Shannon Diversity by Leachate Treatment x Timepoint",
    x = "Hours Post Fertilization",
    y = "Shannon Diversity Index",
    fill = "Leachate"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.title = element_text(size = 12),
    legend.position = "right"
  )

# Combine plots using patchwork
shannon_combined <- shan1 + shan2 / shan3

# Save plots
ggsave(filename = file.path(figures_dir, "shannon_by_leachate.png"), plot = shan1, width = 10, height = 6, dpi = 300)
ggsave(filename = file.path(figures_dir, "shannon_by_timepoint.png"), plot = shan2, width = 10, height = 6, dpi = 300)
ggsave(filename = file.path(figures_dir, "shannon_leachate_x_timepoint.png"), plot = shan3, width = 10, height = 6, dpi = 300)
ggsave(filename = file.path(figures_dir, "shannon_combined.png"), plot = shannon_combined, width = 13, height = 12, dpi = 300)

shannon_combined
```

## Faith's Phylogenetic Diversity

Faith's PD measures the phylogenetic diversity of species in a sample.

```{r, faith-data}
# Load Faith's PD vector
faith <- read_qza(file.path(core_metrics_path, "faith_pd_vector.qza"))

# Create data frame
faith_df <- faith$data 

# View it
head(faith_df)
```

```{r, faith-metadata}
# Join to metadata
faith_df <- faith_df %>%
  rename("SampleID"=V1) %>%
  rename(Faith=V2) %>%
  left_join(metadata, by ="SampleID")
```


```{r, faith-boxplots}
#| fig-width: 13
#| fig-height: 12

# Box plot by leachate treatment
fait1 <- ggplot(faith_df, aes(x = factor(leachate), y = Faith, fill = factor(leachate))) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, size = 2, alpha = 0.6) +
  scale_fill_viridis_d(option = "plasma", begin = 0.2, end = 0.9) +
  labs(
    title = "Faith's Phylogenetic Diversity by Leachate Treatment",
    x = "Leachate Level",
    y = "Faith's Phylogenetic Diversity Metric",
    fill = "Leachate"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.title = element_text(size = 12),
    legend.position = "none"
  )

# Box plot by timepoint
fait2 <- ggplot(faith_df, aes(x = factor(timepoint), y = Faith, fill = factor(timepoint))) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, size = 2, alpha = 0.6) +
  scale_fill_viridis_d(option = "mako", begin = 0.2, end = 0.9) +
  labs(
    title = "Faith's Phylogenetic Diversity by Developmental Timepoint",
    x = "Hours Post Fertilization",
    y = "Faith's Phlyogenetic Diversity Metric",
    fill = "Timepoint"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.title = element_text(size = 12),
    legend.position = "none"
  )

# Box plot by leachate x timepoint interaction
fait3 <- ggplot(faith_df, aes(x = factor(timepoint), y = Faith, fill = factor(leachate))) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA, position = position_dodge(width = 0.8)) +
  geom_point(position = position_jitterdodge(jitter.width = 0.1, dodge.width = 0.8), 
             size = 1.5, alpha = 0.6) +
  scale_fill_viridis_d(option = "plasma", begin = 0.2, end = 0.9) +
  labs(
    title = "Faith's Phylogenetic Diversity by Leachate Treatment x Timepoint",
    x = "Hours Post Fertilization",
    y = "Faith's Phylogenetic Diversity Metric",
    fill = "Leachate"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.title = element_text(size = 12),
    legend.position = "right"
  )

# Combine plots using patchwork
faith_combined <- fait1 + fait2 / fait3

# Save plots
ggsave(filename = file.path(figures_dir, "faith_by_leachate.png"), plot = fait1, width = 10, height = 6, dpi = 300)
ggsave(filename = file.path(figures_dir, "faith_by_timepoint.png"), plot = fait2, width = 10, height = 6, dpi = 300)
ggsave(filename = file.path(figures_dir, "faith_leachate_x_timepoint.png"), plot = fait3, width = 10, height = 6, dpi = 300)
ggsave(filename = file.path(figures_dir, "faith_combined.png"), plot = faith_combined, width = 13, height = 12, dpi = 300)

faith_combined
```

## Pielou's Evenness

Evenness measures how equal species abundances are within a sample.

```{r, pielou-data}
# Load evenness vector
evenness <- read_qza(file.path(core_metrics_path, "evenness_vector.qza"))

# Create data frame
evenness_df <- evenness$data 

# View it
head(evenness_df)
```

```{r}
evenness_df <- evenness_df %>% 
  rownames_to_column("SampleID") %>%
  rename(Evenness = pielou_evenness) %>%
  left_join(metadata, by = "SampleID")

head(evenness_df)
```

```{r, pielou-plots}
#| fig-width: 13
#| fig-height: 12

# Box plot by leachate treatment
piel1 <- ggplot(evenness_df, aes(x = factor(leachate), y = Evenness, fill = factor(leachate))) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, size = 2, alpha = 0.6) +
  scale_fill_viridis_d(option = "plasma", begin = 0.2, end = 0.9) +
  labs(
    title = "Pielou's Evenness by Leachate Treatment",
    x = "Leachate Level",
    y = "Pielou's Evenness",
    fill = "Leachate"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.title = element_text(size = 12),
    legend.position = "none"
  )

# Box plot by timepoint
piel2 <- ggplot(evenness_df, aes(x = factor(timepoint), y = Evenness, fill = factor(timepoint))) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, size = 2, alpha = 0.6) +
  scale_fill_viridis_d(option = "mako", begin = 0.2, end = 0.9) +
  labs(
    title = "Pielou's Evenness by Developmental Timepoint",
    x = "Hours Post Fertilization",
    y = "Pielou's Evenness",
    fill = "Timepoint"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.title = element_text(size = 12),
    legend.position = "none"
  )

# Box plot by leachate x timepoint interaction
piel3 <- ggplot(evenness_df, aes(x = factor(timepoint), y = Evenness, fill = factor(leachate))) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA, position = position_dodge(width = 0.8)) +
  geom_point(position = position_jitterdodge(jitter.width = 0.1, dodge.width = 0.8), 
             size = 1.5, alpha = 0.6) +
  scale_fill_viridis_d(option = "plasma", begin = 0.2, end = 0.9) +
  labs(
    title = "Pielou's Evenness by Leachate Treatment x Timepoint",
    x = "Hours Post Fertilization",
    y = "Pielou's Evenness",
    fill = "Leachate"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.title = element_text(size = 12),
    legend.position = "right"
  )

# Combine plots using patchwork
pielou_combined <- piel1 + piel2 / piel3

# Save plots
ggsave(filename = file.path(figures_dir, "pielou_by_leachate.png"), plot = piel1, width = 10, height = 6, dpi = 300)
ggsave(filename = file.path(figures_dir, "pielou_by_timepoint.png"), plot = piel2, width = 10, height = 6, dpi = 300)
ggsave(filename = file.path(figures_dir, "pielou_leachate_x_timepoint.png"), plot = piel3, width = 10, height = 6, dpi = 300)
ggsave(filename = file.path(figures_dir, "pielou_combined.png"), plot = pielou_combined, width = 13, height = 12, dpi = 300)

pielou_combined
```

## Observed Features (ASV Richness)

The number of unique amplicon sequence variants (ASVs) observed in each sample.

```{r, asv-rich-data}
# Load observed features vector
observed <- read_qza(file.path(core_metrics_path, "observed_features_vector.qza"))

# Create data frame
observed_df <- observed$data 

# View it
head(observed_df)
```
```{r, asv-rich-metadata}
observed_df <- observed_df %>%
  rownames_to_column("SampleID") %>%
  rename(ObservedFeatures = observed_features) %>%
  left_join(metadata, by = "SampleID")
```


```{r, asv-rich-boxplots}
#| fig-width: 13
#| fig-height: 12

# Box plot by leachate treatment
asv1 <- ggplot(observed_df, aes(x = factor(leachate), y = ObservedFeatures, fill = factor(leachate))) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, size = 2, alpha = 0.6) +
  scale_fill_viridis_d(option = "plasma", begin = 0.2, end = 0.9) +
  labs(
    title = "Observed ASV Richness by Leachate Treatment",
    x = "Leachate Level",
    y = "Number of Observed Features",
    fill = "Leachate"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.title = element_text(size = 12),
    legend.position = "none"
  )

# Box plot by timepoint
asv2 <- ggplot(observed_df, aes(x = factor(timepoint), y = ObservedFeatures, fill = factor(timepoint))) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, size = 2, alpha = 0.6) +
  scale_fill_viridis_d(option = "mako", begin = 0.2, end = 0.9) +
  labs(
    title = "Observed ASV Richness by Developmental Timepoint",
    x = "Hours Post Fertilization",
    y = "Number of Observed Features",
    fill = "Timepoint"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.title = element_text(size = 12),
    legend.position = "none"
  )

# Box plot by leachate x timepoint interaction
asv3 <- ggplot(observed_df, aes(x = factor(timepoint), y = ObservedFeatures, fill = factor(leachate))) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA, position = position_dodge(width = 0.8)) +
  geom_point(position = position_jitterdodge(jitter.width = 0.1, dodge.width = 0.8), 
             size = 1.5, alpha = 0.6) +
  scale_fill_viridis_d(option = "plasma", begin = 0.2, end = 0.9) +
  labs(
    title = "Observed ASV Richness by Leachate Treatment x Timepoint",
    x = "Hours Post Fertilization",
    y = "Number of Observed Features",
    fill = "Leachate"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.title = element_text(size = 12),
    legend.position = "right"
  )

# Combine plots using patchwork
asv_combined <- asv1 + asv2 / asv3

# Save plots
ggsave(filename = file.path(figures_dir, "observed_features_by_leachate.png"), plot = asv1, width = 10, height = 6, dpi = 300)
ggsave(filename = file.path(figures_dir, "observed_features_by_timepoint.png"), plot = asv2, width = 10, height = 6, dpi = 300)
ggsave(filename = file.path(figures_dir, "observed_features_leachate_x_timepoint.png"), plot = asv3, width = 10, height = 6, dpi = 300)
ggsave(filename = file.path(figures_dir, "observed_features_combined.png"), plot = asv_combined, width = 13, height = 12, dpi = 300)

asv_combined
```

## Alpha Diversity Summary Panel

```{r}
#| fig-width: 12
#| fig-height: 10

# Combine all alpha diversity metrics
alpha_combined <- shannon_df %>%
  select(SampleID, leachate, timepoint, Shannon) %>%
  left_join(faith_df %>% select(SampleID, Faith), by = "SampleID") %>%
  left_join(evenness_df %>% select(SampleID, Evenness), by = "SampleID") %>%
  left_join(observed_df %>% select(SampleID, ObservedFeatures), by = "SampleID") %>%
  pivot_longer(cols = c(Shannon, Faith, Evenness, ObservedFeatures),
               names_to = "Metric",
               values_to = "Value")

# Panel by leachate
alph1 <- ggplot(alpha_combined, aes(x = factor(leachate), y = Value, fill = factor(leachate), color = factor(leachate))) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter()+
  facet_wrap(~Metric, scales = "free_y", ncol = 2) +
  scale_fill_viridis_d(option = "plasma", begin = 0.2, end = 0.9) +
  labs(
    title = "Alpha Diversity Metrics by Leachate Treatment",
    x = "Leachate Level",
    y = "Diversity Value",
    fill = "Leachate"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.title = element_text(size = 12),
    strip.background = element_rect(fill = "grey90"),
    strip.text = element_text(face = "bold", size = 11),
    legend.position = "none"
  )

# Panel by timepoint
alph2 <- ggplot(alpha_combined, aes(x = factor(timepoint), y = Value, fill = factor(timepoint),  color = factor(timepoint))) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width=0.1, alpha = 0.9)+
  facet_wrap(~Metric, scales = "free_y", ncol = 2) +
  scale_fill_viridis_d(option = "mako", begin = 0.2, end = 0.9) + # palette for boxplot fill
  scale_color_viridis_d(option = "mako", begin = 0.2, end = 0.9) +  # <- same palette for points
  labs(
    title = "Alpha Diversity Metrics by Developmental Timepoint",
    x = "Hours Post Fertilization",
    y = "Diversity Value",
    fill = "Timepoint"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.title = element_text(size = 12),
    strip.background = element_rect(fill = "grey90"),
    strip.text = element_text(face = "bold", size = 11),
    legend.position = "none"
  )

# Save plots
ggsave(filename = file.path(figures_dir, "alpha_diversity_panel_by_leachate.png"), plot = alph1, width = 12, height = 10, dpi = 300)
ggsave(filename = file.path(figures_dir, "alpha_diversity_panel_by_timepoint.png"), plot = alph2, width = 12, height = 10, dpi = 300)

alph1
alph2
```

# Beta Diversity

**Beta diversity measures the dissimilarity in community composition between samples.**

## Bray-Curtis Dissimilarity

Bray-Curtis dissimilarity is based on abundance differences and does not account for phylogeny.

```{r, braycurtis-data}
# Load Bray-Curtis PCoA results
bc_pcoa <- read_qza(file.path(core_metrics_path, "bray_curtis_pcoa_results.qza"))

# Extract principle component coordinates
bc_coords <- bc_pcoa$data$Vectors

str(bc_coords)
```

```{r, braycurtis-metadata}
bc_coords <- bc_coords %>% 
  left_join(metadata, by = "SampleID")

head(bc_coords)

bc_variance <- bc_pcoa$data$ProportionExplained
head(bc_variance)
```


```{r, braycurtis-PCoAplot}
#| fig-width: 10
#| fig-height: 8

# PCoA plot colored by leachate
bray1 <- ggplot(bc_coords, aes(x = PC1, y = PC2, color = factor(leachate), shape = factor(timepoint))) +
  geom_point(size = 4, alpha = 0.8) +
  scale_color_viridis_d(option = "plasma", begin = 0.2, end = 0.9) +
  labs(
    title = "Bray-Curtis PCoA",
    subtitle = "Community composition dissimilarity",
    x = paste0("PC1 (", round(bc_variance[1] * 100, 2), "%)"),
    y = paste0("PC2 (", round(bc_variance[2] * 100, 2), "%)"),
    color = "Leachate",
    shape = "Timepoint"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 11, color = "grey40"),
    axis.title = element_text(size = 12),
    legend.position = "right"
  )

# PCoA plot colored by timepoint
bray2 <- ggplot(bc_coords, aes(x = PC1, y = PC2, color = factor(timepoint), shape = factor(leachate)), fill = factor(cross)) +
  geom_point(size = 4, alpha = 0.8) +
  scale_color_viridis_d(option = "mako", begin = 0.2, end = 0.9) +
  labs(
    title = "Bray-Curtis PCoA",
    subtitle = "Community composition dissimilarity",
    x = paste0("PC1 (", round(bc_variance[1] * 100, 2), "%)"),
    y = paste0("PC2 (", round(bc_variance[2] * 100, 2), "%)"),
    color = "Timepoint (hpf)",
    shape = "Leachate"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 11, color = "grey40"),
    axis.title = element_text(size = 12),
    legend.position = "right"
  )

# Save plots
ggsave(filename = file.path(figures_dir, "bray_curtis_by_leachate.png"), plot = bray1, width = 10, height = 8, dpi = 300)
ggsave(filename = file.path(figures_dir, "bray_curtis_by_timepoint.png"), plot = bray2, width = 10, height = 8, dpi = 300)

bray1
bray2
```
::: callout-note
44.35% of variation explained by... parental cross? How do we add that info into the figure?
:::


## Jaccard Distance

Jaccard distance is based on presence/absence and does not account for phylogeny.

```{r}
# Load Jaccard PCoA results
jac_pcoa <- read_qza(file.path(core_metrics_path, "jaccard_pcoa_results.qza"))

# Extract coordinates and variance explained
jac_coords <- jac_pcoa$data$Vectors 

# View 
head(jac_coords)
```

```{r}
jac_coords <- jac_coords %>%
  left_join(metadata, by = "SampleID")

head(jac_coords)

jac_variance <- jac_pcoa$data$ProportionExplained

head(jac_variance)
```

```{r}
#| fig-width: 13
#| fig-height: 8

# PCoA plot colored by leachate
jacc1 <- ggplot(jac_coords, aes(x = PC1, y = PC2, color = factor(leachate), shape = factor(timepoint))) +
  geom_point(size = 4, alpha = 0.8) +
  scale_color_viridis_d(option = "plasma", begin = 0.2, end = 0.9) +
  labs(
    title = "Jaccard PCoA",
    subtitle = "Presence/absence dissimilarity",
    x = paste0("PC1 (", round(jac_variance[1] * 100, 2), "%)"),
    y = paste0("PC2 (", round(jac_variance[2] * 100, 2), "%)"),
    color = "Leachate",
    shape = "Timepoint"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 11, color = "grey40"),
    axis.title = element_text(size = 12),
    legend.position = "right"
  )

# PCoA plot colored by timepoint
jacc2 <- ggplot(jac_coords, aes(x = PC1, y = PC2, color = factor(timepoint), shape = factor(leachate))) +
  geom_point(size = 4, alpha = 0.8) +
  scale_color_viridis_d(option = "mako", begin = 0.2, end = 0.9) +
  labs(
    title = "Jaccard PCoA",
    subtitle = "Presence/absence dissimilarity",
    x = paste0("PC1 (", round(jac_variance[1] * 100, 2), "%)"),
    y = paste0("PC2 (", round(jac_variance[2] * 100, 2), "%)"),
    color = "Timepoint (hpf)",
    shape = "Leachate"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 11, color = "grey40"),
    axis.title = element_text(size = 12),
    legend.position = "right"
  )

# Save plots
ggsave(filename = file.path(figures_dir, "jaccard_by_leachate.png"), plot = jacc1, width = 10, height = 8, dpi = 300)
ggsave(filename = file.path(figures_dir, "jaccard_by_timepoint.png"), plot = jacc2, width = 10, height = 8, dpi = 300)

jacc1
jacc2
```

## Weighted UniFrac Distance

Weighted UniFrac considers phylogenetic distances and abundance differences.

```{r}
# Load Weighted UniFrac PCoA results
wuf_pcoa <- read_qza(file.path(core_metrics_path, "weighted_unifrac_pcoa_results.qza"))

# Extract coordinates and variance explained
wuf_coords <- wuf_pcoa$data$Vectors 

head(wuf_coords)
```

```{r}
wuf_coords <- wuf_coords %>%
  left_join(metadata, by = "SampleID")

wuf_variance <- wuf_pcoa$data$ProportionExplained
```


```{r}
#| fig-width: 13
#| fig-height: 8

# PCoA plot colored by leachate
wufr1 <- ggplot(wuf_coords, aes(x = PC1, y = PC2, color = factor(leachate), shape = factor(timepoint))) +
  geom_point(size = 4, alpha = 0.8) +
  scale_color_viridis_d(option = "plasma", begin = 0.2, end = 0.9) +
  labs(
    title = "Weighted UniFrac PCoA",
    subtitle = "Phylogenetic dissimilarity (abundance-weighted)",
    x = paste0("PC1 (", round(wuf_variance[1] * 100, 2), "%)"),
    y = paste0("PC2 (", round(wuf_variance[2] * 100, 2), "%)"),
    color = "Leachate",
    shape = "Timepoint"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 11, color = "grey40"),
    axis.title = element_text(size = 12),
    legend.position = "right"
  )

# PCoA plot colored by timepoint
wufr2 <- ggplot(wuf_coords, aes(x = PC1, y = PC2, color = factor(timepoint), shape = factor(leachate))) +
  geom_point(size = 4, alpha = 0.8) +
  scale_color_viridis_d(option = "mako", begin = 0.2, end = 0.9) +
  labs(
    title = "Weighted UniFrac PCoA",
    subtitle = "Phylogenetic dissimilarity (abundance-weighted)",
    x = paste0("PC1 (", round(wuf_variance[1] * 100, 2), "%)"),
    y = paste0("PC2 (", round(wuf_variance[2] * 100, 2), "%)"),
    color = "Timepoint (hpf)",
    shape = "Leachate"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 11, color = "grey40"),
    axis.title = element_text(size = 12),
    legend.position = "right"
  )

# Save plots
ggsave(filename = file.path(figures_dir, "weighted_unifrac_by_leachate.png"), plot = wufr1, width = 10, height = 8, dpi = 300)
ggsave(filename = file.path(figures_dir, "weighted_unifrac_by_timepoint.png"), plot = wufr2, width = 10, height = 8, dpi = 300)

wufr1
wufr2
```

## Unweighted UniFrac Distance

Unweighted UniFrac considers phylogenetic distances but not abundance (presence/absence only).

```{r}
# Load Unweighted UniFrac PCoA results
uwuf_pcoa <- read_qza(file.path(core_metrics_path, "unweighted_unifrac_pcoa_results.qza"))

# Extract coordinates and variance explained
uwuf_coords <- uwuf_pcoa$data$Vectors %>%
  left_join(metadata, by = "SampleID")

uwuf_variance <- uwuf_pcoa$data$ProportionExplained
```

```{r}
#| fig-width: 10
#| fig-height: 8

# PCoA plot colored by leachate
uwuf1 <- ggplot(uwuf_coords, aes(x = PC1, y = PC2, color = factor(leachate), shape = factor(timepoint))) +
  geom_point(size = 4, alpha = 0.8) +
  scale_color_viridis_d(option = "plasma", begin = 0.2, end = 0.9) +
  labs(
    title = "Unweighted UniFrac PCoA",
    subtitle = "Phylogenetic dissimilarity (presence/absence)",
    x = paste0("PC1 (", round(uwuf_variance[1] * 100, 2), "%)"),
    y = paste0("PC2 (", round(uwuf_variance[2] * 100, 2), "%)"),
    color = "Leachate",
    shape = "Timepoint"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 11, color = "grey40"),
    axis.title = element_text(size = 12),
    legend.position = "right"
  )

# PCoA plot colored by timepoint
uwuf2 <- ggplot(uwuf_coords, aes(x = PC1, y = PC2, color = factor(timepoint), shape = factor(leachate))) +
  geom_point(size = 4, alpha = 0.8) +
  scale_color_viridis_d(option = "mako", begin = 0.2, end = 0.9) +
  labs(
    title = "Unweighted UniFrac PCoA",
    subtitle = "Phylogenetic dissimilarity (presence/absence)",
    x = paste0("PC1 (", round(uwuf_variance[1] * 100, 2), "%)"),
    y = paste0("PC2 (", round(uwuf_variance[2] * 100, 2), "%)"),
    color = "Timepoint (hpf)",
    shape = "Leachate"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 11, color = "grey40"),
    axis.title = element_text(size = 12),
    legend.position = "right"
  )

# Save plots
ggsave(filename = file.path(figures_dir, "unweighted_unifrac_by_leachate.png"), plot = uwuf1, width = 10, height = 8, dpi = 300)
ggsave(filename = file.path(figures_dir, "unweighted_unifrac_by_timepoint.png"), plot = uwuf2, width = 10, height = 8, dpi = 300)

uwuf1
uwuf2
```

## Beta Diversity Summary Panel

```{r}
#| fig-width: 14
#| fig-height: 12

# Combine all beta diversity PCoA plots by leachate
beta_leachate <- (bray1 + jacc1) / (wufr1 + uwuf1) +
  plot_annotation(
    title = "Beta Diversity PCoA Plots - Colored by Leachate Treatment",
    theme = theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5))
  )

# Combine all beta diversity PCoA plots by timepoint
beta_timepoint <- (bray2 + jacc2) / (wufr2 + uwuf2) +
  plot_annotation(
    title = "Beta Diversity PCoA Plots - Colored by Developmental Timepoint",
    theme = theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5))
  )

# Save plots
ggsave(filename = file.path(figures_dir, "beta_diversity_panel_by_leachate.png"), plot = beta_leachate, width = 14, height = 12, dpi = 300)
ggsave(filename = file.path(figures_dir, "beta_diversity_panel_by_timepoint.png"), plot = beta_timepoint, width = 14, height = 12, dpi = 300)

beta_leachate
beta_timepoint
```

# Summary

This document provides manuscript-ready visualizations of all core diversity metrics from the filtered dataset:

**Alpha Diversity Metrics:**
- Shannon Diversity Index
- Faith's Phylogenetic Diversity
- Pielou's Evenness
- Observed ASV Richness
- Alpha Diversity Summary Panel (all metrics combined)

**Beta Diversity Metrics:**
- Bray-Curtis dissimilarity (abundance-based)
- Jaccard distance (presence/absence)
- Weighted UniFrac distance (phylogenetic + abundance)
- Unweighted UniFrac distance (phylogenetic presence/absence)
- Beta Diversity Summary Panel (all PCoA plots combined)

Each metric is visualized by both leachate treatment level and developmental timepoint (hours post fertilization), allowing for comprehensive assessment of how microbiome diversity changes with PVC leachate exposure and coral development.

**All plots are automatically saved to the `output/figures/` directory** for easy access and manuscript preparation.
